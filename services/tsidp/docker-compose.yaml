services:
  tsidp:
    container_name: tsidp
    image: ghcr.io/tailscale/tsidp:latest
    volumes:
      - tsidp-data:/data
    environment:
      # tsidp is experimental - needed while version <1.0.0
      - TAILSCALE_USE_WIP_CODE=1
      - TS_STATE_DIR=/data
      - TS_HOSTNAME=idp
      # Enable OAuth token exchange
      - TSIDP_ENABLE_STS=1
    secrets:
      - tsidp_authkey
    user: "0:0"  # Start as root to fix permissions, then drop to app user
    entrypoint:
      - /bin/sh
      - -c
      - |
        echo '--- Fixing permissions ---'
        chown -R app:app /data
        chmod -R u+rwX /data
        export TS_AUTHKEY=$$(cat /run/secrets/tsidp_authkey)
        exec su -s /bin/sh app -c "TS_AUTHKEY='$$TS_AUTHKEY' /run.sh"

volumes:
  tsidp-data:

secrets:
  tsidp_authkey:
    file: ${PWD}/../secrets/tsidp.authkey
